<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªùi Kh√≥a Bi·ªÉu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .morning-period { 
            background: rgba(59, 130, 246, 0.1); 
            border-left: 3px solid rgba(59, 130, 246, 0.3); 
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.05);
        }
        .afternoon-period { 
            background: rgba(245, 158, 11, 0.1); 
            border-left: 3px solid rgba(245, 158, 11, 0.3); 
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.05);
        }
        .morning-header { 
            background: rgba(59, 130, 246, 0.15); 
            color: #1e40af; 
            font-weight: 600;
        }
        .afternoon-header { 
            background: rgba(245, 158, 11, 0.15); 
            color: #92400e; 
            font-weight: 600;
        }
        .schedule-cell { transition: all 0.2s ease; }
        .schedule-cell:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-white min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-2xl font-semibold text-gray-800 mb-4">üìÖ Th·ªùi kh√≥a bi·ªÉu tr∆∞·ªùng THPT Nguy·ªÖn Khuy·∫øn</h1>
            <p class="text-sm text-gray-600 mb-4">√Åp d·ª•ng t·ª´ ng√†y 8/9/2025</p>
            

            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="flex items-center gap-3">
                    <label for="csvFile" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md cursor-pointer text-sm font-medium transition-colors">
                        üìÅ Ch·ªçn file CSV
                    </label>
                    <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                </div>
                
                <select id="viewMode" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="changeViewMode()">
                    <option value="class">Coi theo l·ªõp</option>
                    <option value="teacher">Coi theo gi√°o vi√™n</option>
                </select>
                
                <select id="displayMode" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="renderSchedule()">
                    <option value="full">ƒê·∫ßy ƒë·ªß</option>
                    <option value="compact">R√∫t g·ªçn</option>
                </select>
                
                <select id="filterSelect" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="applyFilter()">
                    <option value="">Ch·ªçn l·ªõp</option>
                    <option value="12A1">12A1</option>
                    <option value="12A2">12A2</option>
                </select>
            </div>
            
            <div class="flex items-center gap-3 mt-4">
                <div class="flex items-center gap-3">
                    <input type="text" id="studentNameInput" placeholder="Nh·∫≠p t√™n h·ªçc sinh..." class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white">
                    <button id="exportWallpaperBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors hidden" onclick="exportAsWallpaper()">
                        üì± Xu·∫•t h√¨nh n·ªÅn ƒëi·ªán tho·∫°i
                    </button>
                </div>
            </div>
            
            <div class="text-sm text-gray-600 mt-4">
                <span class="inline-block w-3 h-3 bg-yellow-200 border-l-2 border-yellow-500 mr-2"></span>Ti·∫øt s√°ng
                <span class="inline-block w-3 h-3 bg-green-100 border-l-2 border-green-500 mr-2 ml-4"></span>Ti·∫øt chi·ªÅu
            </div>
        </div>

        <!-- Statistics -->
        <div id="statisticsPanel" class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä Th·ªëng k√™</h3>
            <div id="statsContent" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Statistics will be populated by JavaScript -->
            </div>
        </div>

        <!-- Schedule Table -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                <table class="w-full min-w-[700px]">
                    <thead>
                        <tr class="bg-gray-100 border-b">
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 sticky left-0 bg-gray-100 z-10 min-w-[80px]">Ti·∫øt</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 min-w-[120px]">Th·ª© 2</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 min-w-[120px]">Th·ª© 3</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 min-w-[120px]">Th·ª© 4</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 min-w-[120px]">Th·ª© 5</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 min-w-[120px]">Th·ª© 6</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 min-w-[120px]">Th·ª© 7</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                        <tr><td colspan="7" class="text-center py-8 text-gray-500">Vui l√≤ng ch·ªçn file CSV ƒë·ªÉ xem th·ªùi kh√≥a bi·ªÉu</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sample CSV Format -->
        <div class="bg-white rounded-lg shadow-sm p-6 mt-6">
            <h3 class="text-lg font-medium text-gray-800 mb-3">üìã ƒê·ªãnh d·∫°ng file CSV</h3>
            <div class="bg-gray-50 rounded-md p-4 text-sm font-mono text-gray-700">
                <div class="mb-2 font-semibold">Day,Period,Class,Subject,Teachers,Room</div>
                <div>sang2,1,12A1,To√°n,Nguy·ªÖn VƒÉn A,101</div>
                <div>sang2,2,12A1,L√Ω,Tr·∫ßn Th·ªã B,102</div>
                <div>chieu2,1,12A1,H√≥a,L√™ VƒÉn C,103</div>
            </div>
            <p class="text-sm text-gray-600 mt-2">
                <strong>L∆∞u √Ω:</strong> Day format: sang2-sang7, chieu2-chieu7 | Period: 1-5
            </p>
        </div>
    </div>

    <script>
        let scheduleData = [
            // D·ªØ li·ªáu m·∫´u
            {day: 'sang2', period: 1, class: '12A1', subject: 'To√°n', teacher: 'Nguy·ªÖn VƒÉn A', room: '101'},
            {day: 'sang2', period: 2, class: '12A1', subject: 'L√Ω', teacher: 'Tr·∫ßn Th·ªã B', room: '102'},
            {day: 'sang2', period: 3, class: '12A1', subject: 'H√≥a', teacher: 'L√™ VƒÉn C', room: '103'},
            {day: 'chieu2', period: 1, class: '12A1', subject: 'VƒÉn', teacher: 'Ph·∫°m Th·ªã D', room: '104'},
            {day: 'chieu2', period: 2, class: '12A1', subject: 'Anh', teacher: 'Ho√†ng VƒÉn E', room: '105'},
            
            {day: 'sang3', period: 1, class: '12A1', subject: 'Sinh', teacher: 'V≈© Th·ªã F', room: '106'},
            {day: 'sang3', period: 2, class: '12A1', subject: 'S·ª≠', teacher: 'ƒê·ªó VƒÉn G', room: '107'},
            {day: 'sang3', period: 3, class: '12A1', subject: 'ƒê·ªãa', teacher: 'B√πi Th·ªã H', room: '108'},
            {day: 'chieu3', period: 1, class: '12A1', subject: 'GDCD', teacher: 'Ng√¥ VƒÉn I', room: '109'},
            
            {day: 'sang4', period: 1, class: '12A1', subject: 'To√°n', teacher: 'Nguy·ªÖn VƒÉn A', room: '101'},
            {day: 'sang4', period: 2, class: '12A1', subject: 'L√Ω', teacher: 'Tr·∫ßn Th·ªã B', room: '102'},
            {day: 'chieu4', period: 1, class: '12A1', subject: 'Th·ªÉ d·ª•c', teacher: 'L√Ω VƒÉn J', room: 'S√¢n'},
            {day: 'chieu4', period: 2, class: '12A1', subject: 'Tin h·ªçc', teacher: 'Tr∆∞∆°ng Th·ªã K', room: '201'},
            
            {day: 'sang5', period: 1, class: '12A1', subject: 'VƒÉn', teacher: 'Ph·∫°m Th·ªã D', room: '104'},
            {day: 'sang5', period: 2, class: '12A1', subject: 'Anh', teacher: 'Ho√†ng VƒÉn E', room: '105'},
            {day: 'sang5', period: 3, class: '12A1', subject: 'H√≥a', teacher: 'L√™ VƒÉn C', room: '103'},
            {day: 'chieu5', period: 1, class: '12A1', subject: 'Sinh', teacher: 'V≈© Th·ªã F', room: '106'},
            
            {day: 'sang6', period: 1, class: '12A1', subject: 'To√°n', teacher: 'Nguy·ªÖn VƒÉn A', room: '101'},
            {day: 'sang6', period: 2, class: '12A1', subject: 'L√Ω', teacher: 'Tr·∫ßn Th·ªã B', room: '102'},
            {day: 'chieu6', period: 1, class: '12A1', subject: 'Ch√†o c·ªù', teacher: 'T·∫•t c·∫£ GV', room: 'S√¢n'},
            
            // L·ªõp 12A2
            {day: 'sang2', period: 1, class: '12A2', subject: 'VƒÉn', teacher: 'Ph·∫°m Th·ªã D', room: '201'},
            {day: 'sang2', period: 2, class: '12A2', subject: 'To√°n', teacher: 'Nguy·ªÖn VƒÉn A', room: '202'},
            {day: 'sang2', period: 3, class: '12A2', subject: 'Anh', teacher: 'Ho√†ng VƒÉn E', room: '203'},
            {day: 'chieu2', period: 1, class: '12A2', subject: 'L√Ω', teacher: 'Tr·∫ßn Th·ªã B', room: '204'},
            {day: 'chieu2', period: 2, class: '12A2', subject: 'H√≥a', teacher: 'L√™ VƒÉn C', room: '205'},
            
            {day: 'sang3', period: 1, class: '12A2', subject: 'To√°n', teacher: 'Nguy·ªÖn VƒÉn A', room: '202'},
            {day: 'sang3', period: 2, class: '12A2', subject: 'Sinh', teacher: 'V≈© Th·ªã F', room: '206'},
            {day: 'chieu3', period: 1, class: '12A2', subject: 'S·ª≠', teacher: 'ƒê·ªó VƒÉn G', room: '207'},
            {day: 'chieu3', period: 2, class: '12A2', subject: 'ƒê·ªãa', teacher: 'B√πi Th·ªã H', room: '208'},
            
            {day: 'sang4', period: 1, class: '12A2', subject: 'VƒÉn', teacher: 'Ph·∫°m Th·ªã D', room: '201'},
            {day: 'sang4', period: 2, class: '12A2', subject: 'Anh', teacher: 'Ho√†ng VƒÉn E', room: '203'},
            {day: 'chieu4', period: 1, class: '12A2', subject: 'Tin h·ªçc', teacher: 'Tr∆∞∆°ng Th·ªã K', room: '301'},
            
            {day: 'sang5', period: 1, class: '12A2', subject: 'L√Ω', teacher: 'Tr·∫ßn Th·ªã B', room: '204'},
            {day: 'sang5', period: 2, class: '12A2', subject: 'H√≥a', teacher: 'L√™ VƒÉn C', room: '205'},
            {day: 'chieu5', period: 1, class: '12A2', subject: 'Th·ªÉ d·ª•c', teacher: 'L√Ω VƒÉn J', room: 'S√¢n'},
            {day: 'chieu5', period: 2, class: '12A2', subject: 'GDCD', teacher: 'Ng√¥ VƒÉn I', room: '209'},
            
            {day: 'sang6', period: 1, class: '12A2', subject: 'To√°n', teacher: 'Nguy·ªÖn VƒÉn A', room: '202'},
            {day: 'sang6', period: 2, class: '12A2', subject: 'VƒÉn', teacher: 'Ph·∫°m Th·ªã D', room: '201'},
            {day: 'chieu6', period: 1, class: '12A2', subject: 'Ch√†o c·ªù', teacher: 'T·∫•t c·∫£ GV', room: 'S√¢n'}
        ];
        let allClasses = new Set(['12A1', '12A2']);
        let allTeachers = new Set(['Nguy·ªÖn VƒÉn A', 'Tr·∫ßn Th·ªã B', 'L√™ VƒÉn C', 'Ph·∫°m Th·ªã D', 'Ho√†ng VƒÉn E', 'V≈© Th·ªã F', 'ƒê·ªó VƒÉn G', 'B√πi Th·ªã H', 'Ng√¥ VƒÉn I', 'L√Ω VƒÉn J', 'Tr∆∞∆°ng Th·ªã K']);
        let currentFilter = '';
        let currentViewMode = 'class';
        let currentDisplayMode = 'full';

        const dayMapping = {
            'sang2': { day: 1, session: 'morning' }, 'chieu2': { day: 1, session: 'afternoon' },
            'sang3': { day: 2, session: 'morning' }, 'chieu3': { day: 2, session: 'afternoon' },
            'sang4': { day: 3, session: 'morning' }, 'chieu4': { day: 3, session: 'afternoon' },
            'sang5': { day: 4, session: 'morning' }, 'chieu5': { day: 4, session: 'afternoon' },
            'sang6': { day: 5, session: 'morning' }, 'chieu6': { day: 5, session: 'afternoon' },
            'sang7': { day: 6, session: 'morning' }, 'chieu7': { day: 6, session: 'afternoon' }
        };

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                parseCSV(csv);
            };
            reader.readAsText(file);
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',');
            
            scheduleData = [];
            allClasses.clear();
            allTeachers.clear();

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= 6) {
                    const record = {
                        day: values[0].trim(),
                        period: parseInt(values[1].trim()),
                        class: values[2].trim(),
                        subject: values[3].trim(),
                        teacher: values[4].trim(),
                        room: values[5].trim()
                    };
                    scheduleData.push(record);
                    allClasses.add(record.class);
                    allTeachers.add(record.teacher);
                }
            }

            updateFilterSelect();
            showNotification('ƒê√£ t·∫£i file CSV th√†nh c√¥ng!', 'success');
        }

        function updateFilterSelect() {
            const select = document.getElementById('filterSelect');
            const viewMode = document.getElementById('viewMode').value;
            
            select.innerHTML = '';
            
            if (viewMode === 'class') {
                select.innerHTML = '<option value="">Ch·ªçn l·ªõp</option>';
                Array.from(allClasses).sort().forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">Ch·ªçn gi√°o vi√™n</option>';
                Array.from(allTeachers).sort().forEach(teacherName => {
                    const option = document.createElement('option');
                    option.value = teacherName;
                    option.textContent = teacherName;
                    select.appendChild(option);
                });
            }
        }

        function changeViewMode() {
            currentViewMode = document.getElementById('viewMode').value;
            currentDisplayMode = document.getElementById('displayMode').value;
            updateFilterSelect();
            document.getElementById('filterSelect').value = '';
            currentFilter = '';
            document.getElementById('scheduleBody').innerHTML = 
                '<tr><td colspan="7" class="text-center py-8 text-gray-500">Vui l√≤ng ch·ªçn ' + 
                (currentViewMode === 'class' ? 'l·ªõp' : 'gi√°o vi√™n') + '</td></tr>';
        }

        function applyFilter() {
            const selectedFilter = document.getElementById('filterSelect').value;
            currentFilter = selectedFilter;
            currentDisplayMode = document.getElementById('displayMode').value;
            
            if (!selectedFilter) {
                document.getElementById('scheduleBody').innerHTML = 
                    '<tr><td colspan="7" class="text-center py-8 text-gray-500">Vui l√≤ng ch·ªçn ' + 
                    (currentViewMode === 'class' ? 'l·ªõp' : 'gi√°o vi√™n') + '</td></tr>';
                return;
            }

            renderSchedule();
        }

        function renderSchedule() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            // Create schedule grid: [session][period][day]
            const schedule = {
                morning: Array(5).fill().map(() => Array(6).fill(null)),
                afternoon: Array(5).fill().map(() => Array(6).fill(null))
            };

            // Filter data based on current view mode and filter
            const filteredData = scheduleData.filter(record => {
                if (currentViewMode === 'class') {
                    return record.class === currentFilter;
                } else {
                    return record.teacher === currentFilter;
                }
            });

            // Fill schedule with filtered data
            filteredData.forEach(record => {
                const dayInfo = dayMapping[record.day];
                if (dayInfo && record.period >= 1 && record.period <= 5) {
                    const dayIndex = dayInfo.day - 1;
                    const periodIndex = record.period - 1;
                    schedule[dayInfo.session][periodIndex][dayIndex] = record;
                }
            });

            // Calculate statistics
            updateStatistics(filteredData);

            // Determine which periods/days have data
            const hasDataInPeriod = {
                morning: Array(5).fill(false),
                afternoon: Array(5).fill(false)
            };
            const hasDataInDay = Array(6).fill(false);

            schedule.morning.forEach((periods, periodIndex) => {
                periods.forEach((record, dayIndex) => {
                    if (record) {
                        hasDataInPeriod.morning[periodIndex] = true;
                        hasDataInDay[dayIndex] = true;
                    }
                });
            });

            schedule.afternoon.forEach((periods, periodIndex) => {
                periods.forEach((record, dayIndex) => {
                    if (record) {
                        hasDataInPeriod.afternoon[periodIndex] = true;
                        hasDataInDay[dayIndex] = true;
                    }
                });
            });

            // Update table headers to hide empty days
            updateTableHeaders(hasDataInDay);

            // Show notification about current view
            showViewNotification();
            
            // Show export wallpaper button
            document.getElementById('exportWallpaperBtn').classList.remove('hidden');

            // Render morning periods (skip empty periods)
            for (let period = 0; period < 5; period++) {
                if (!hasDataInPeriod.morning[period]) continue;
                
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100';

                // Time slot cell
                const timeCell = document.createElement('td');
                timeCell.className = 'px-4 py-3 text-sm font-medium morning-header sticky left-0 z-10 border-r border-gray-200';
                timeCell.innerHTML = `<div class="font-semibold">S√°ng ${period + 1}</div>`;
                tr.appendChild(timeCell);

                // Subject cells (skip empty days)
                for (let day = 0; day < 6; day++) {
                    if (!hasDataInDay[day]) continue;
                    
                    const td = document.createElement('td');
                    const record = schedule.morning[period][day];
                    
                    if (record) {
                        td.className = 'px-4 py-4 text-center schedule-cell morning-period border-r border-gray-100';
                        
                        if (currentDisplayMode === 'full') {
                            if (currentViewMode === 'class') {
                                td.innerHTML = `
                                    <div class="text-lg font-bold text-blue-800 mb-2">${record.subject}</div>
                                    <div class="text-base text-purple-700 font-medium mb-1">${record.teacher}</div>
                                    <div class="text-base text-orange-600 font-semibold">P.${record.room}</div>
                                `;
                            } else {
                                td.innerHTML = `
                                    <div class="text-base font-medium text-blue-700 mb-1">${record.subject} - ${record.class}</div>
                                    <div class="text-lg font-bold text-green-700 mb-2">${record.teacher}</div>
                                    <div class="text-base text-orange-600 font-semibold">P.${record.room}</div>
                                `;
                            }
                        } else {
                            // Compact mode - only show subject and room for both class and teacher view
                            td.innerHTML = `
                                <div class="text-base font-medium text-blue-700">${record.subject}</div>
                                <div class="text-base text-orange-600 font-semibold">P.${record.room}</div>
                            `;
                        }
                    } else {
                        td.className = 'px-4 py-4 text-center bg-white border-r border-gray-100';
                        td.innerHTML = '<div class="text-gray-400 text-base">-</div>';
                    }
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }

            // Add break row if both morning and afternoon have data
            const hasMorningData = hasDataInPeriod.morning.some(Boolean);
            const hasAfternoonData = hasDataInPeriod.afternoon.some(Boolean);
            
            if (hasMorningData && hasAfternoonData) {
                const breakRow = document.createElement('tr');
                const activeDays = hasDataInDay.filter(Boolean).length;
                breakRow.innerHTML = `
                    <td class="px-4 py-2 text-center bg-gray-100 font-medium text-gray-600 sticky left-0 z-10 border-r border-gray-200">Ngh·ªâ tr∆∞a</td>
                    <td colspan="${activeDays}" class="px-4 py-2 text-center bg-gray-50 text-gray-500 text-sm"></td>
                `;
                tbody.appendChild(breakRow);
            }

            // Render afternoon periods (skip empty periods)
            for (let period = 0; period < 5; period++) {
                if (!hasDataInPeriod.afternoon[period]) continue;
                
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100';

                // Time slot cell
                const timeCell = document.createElement('td');
                timeCell.className = 'px-4 py-3 text-sm font-medium afternoon-header sticky left-0 z-10 border-r border-gray-200';
                timeCell.innerHTML = `<div class="font-semibold">Chi·ªÅu ${period + 1}</div>`;
                tr.appendChild(timeCell);

                // Subject cells (skip empty days)
                for (let day = 0; day < 6; day++) {
                    if (!hasDataInDay[day]) continue;
                    
                    const td = document.createElement('td');
                    const record = schedule.afternoon[period][day];
                    
                    if (record) {
                        td.className = 'px-4 py-4 text-center schedule-cell afternoon-period border-r border-gray-100';
                        
                        if (currentDisplayMode === 'full') {
                            if (currentViewMode === 'class') {
                                td.innerHTML = `
                                    <div class="text-lg font-bold text-blue-800 mb-2">${record.subject}</div>
                                    <div class="text-base text-purple-700 font-medium mb-1">${record.teacher}</div>
                                    <div class="text-base text-orange-600 font-semibold">P.${record.room}</div>
                                `;
                            } else {
                                td.innerHTML = `
                                    <div class="text-base font-medium text-blue-700 mb-1">${record.subject} - ${record.class}</div>
                                    <div class="text-lg font-bold text-green-700 mb-2">${record.teacher}</div>
                                    <div class="text-base text-orange-600 font-semibold">P.${record.room}</div>
                                `;
                            }
                        } else {
                            // Compact mode - only show subject and room for both class and teacher view
                            td.innerHTML = `
                                <div class="text-base font-medium text-blue-700">${record.subject}</div>
                                <div class="text-base text-orange-600 font-semibold">P.${record.room}</div>
                            `;
                        }
                    } else {
                        td.className = 'px-4 py-4 text-center bg-white border-r border-gray-100';
                        td.innerHTML = '<div class="text-gray-400 text-base">-</div>';
                    }
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        function updateTableHeaders(hasDataInDay) {
            const thead = document.querySelector('thead tr');
            const ths = thead.querySelectorAll('th');
            
            // Show/hide day columns based on data availability
            for (let i = 1; i < ths.length; i++) {
                const dayIndex = i - 1;
                if (hasDataInDay[dayIndex]) {
                    ths[i].style.display = '';
                } else {
                    ths[i].style.display = 'none';
                }
            }
        }

        function updateStatistics(filteredData) {
            const statsPanel = document.getElementById('statisticsPanel');
            const statsContent = document.getElementById('statsContent');
            
            if (filteredData.length === 0) {
                statsPanel.classList.add('hidden');
                return;
            }
            
            statsPanel.classList.remove('hidden');
            
            if (currentViewMode === 'class') {
                // Statistics for class view
                let morningPeriods = 0;
                let afternoonPeriods = 0;
                const subjects = new Set();
                
                filteredData.forEach(record => {
                    const dayInfo = dayMapping[record.day];
                    if (dayInfo) {
                        if (dayInfo.session === 'morning') {
                            morningPeriods++;
                        } else {
                            afternoonPeriods++;
                        }
                        subjects.add(record.subject);
                    }
                });
                
                statsContent.innerHTML = `
                    <div class="p-4 rounded-lg border border-orange-200" style="background: linear-gradient(135deg, #fef7ed 0%, #fed7aa 100%);">
                        <div class="text-2xl font-bold text-orange-700">${morningPeriods}</div>
                        <div class="text-sm text-orange-600 font-medium">Ti·∫øt s√°ng/tu·∫ßn</div>
                    </div>
                    <div class="p-4 rounded-lg border border-green-200" style="background: linear-gradient(135deg, #f0fdf4 0%, #bbf7d0 100%);">
                        <div class="text-2xl font-bold text-green-700">${afternoonPeriods}</div>
                        <div class="text-sm text-green-600 font-medium">Ti·∫øt chi·ªÅu/tu·∫ßn</div>
                    </div>
                    <div class="p-4 rounded-lg border border-blue-200" style="background: linear-gradient(135deg, #eff6ff 0%, #bfdbfe 100%);">
                        <div class="text-2xl font-bold text-blue-700">${morningPeriods + afternoonPeriods}</div>
                        <div class="text-sm text-blue-600 font-medium">T·ªïng ti·∫øt/tu·∫ßn</div>
                    </div>
                    <div class="p-4 rounded-lg border border-purple-200" style="background: linear-gradient(135deg, #faf5ff 0%, #ddd6fe 100%);">
                        <div class="text-2xl font-bold text-purple-700">${subjects.size}</div>
                        <div class="text-sm text-purple-600 font-medium">S·ªë m√¥n h·ªçc</div>
                    </div>
                `;
            } else {
                // Statistics for teacher view
                const totalPeriods = filteredData.length;
                const workingDays = new Set();
                const subjects = new Set();
                
                filteredData.forEach(record => {
                    const dayInfo = dayMapping[record.day];
                    if (dayInfo) {
                        workingDays.add(dayInfo.day);
                        subjects.add(record.subject);
                    }
                });
                
                const restDays = 6 - workingDays.size;
                
                statsContent.innerHTML = `
                    <div class="p-4 rounded-lg border border-blue-200" style="background: linear-gradient(135deg, #eff6ff 0%, #bfdbfe 100%);">
                        <div class="text-2xl font-bold text-blue-700">${totalPeriods}</div>
                        <div class="text-sm text-blue-600 font-medium">T·ªïng ti·∫øt/tu·∫ßn</div>
                    </div>
                    <div class="p-4 rounded-lg border border-green-200" style="background: linear-gradient(135deg, #f0fdf4 0%, #bbf7d0 100%);">
                        <div class="text-2xl font-bold text-green-700">${workingDays.size}</div>
                        <div class="text-sm text-green-600 font-medium">Ng√†y d·∫°y</div>
                    </div>
                    <div class="p-4 rounded-lg border border-gray-200" style="background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%);">
                        <div class="text-2xl font-bold text-gray-700">${restDays}</div>
                        <div class="text-sm text-gray-600 font-medium">Ng√†y ngh·ªâ</div>
                    </div>
                    <div class="p-4 rounded-lg border border-purple-200" style="background: linear-gradient(135deg, #faf5ff 0%, #ddd6fe 100%);">
                        <div class="text-2xl font-bold text-purple-700">${subjects.size}</div>
                        <div class="text-sm text-purple-600 font-medium">S·ªë m√¥n d·∫°y</div>
                    </div>
                `;
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white text-sm font-medium z-50 transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function showViewNotification() {
            if (!currentFilter) return;
            
            let message = '';
            if (currentViewMode === 'class') {
                message = `B·∫°n ƒëang xem th·ªùi kh√≥a bi·ªÉu c·ªßa l·ªõp ${currentFilter}`;
            } else {
                // Determine gender based on name patterns (simple heuristic)
                const isTeacherFemale = currentFilter.includes('Th·ªã') || currentFilter.includes('Th·ªã ') || 
                                       currentFilter.endsWith('a') || currentFilter.endsWith('√¢n') ||
                                       currentFilter.includes('Nguy·ªÖn Th·ªã') || currentFilter.includes('Tr·∫ßn Th·ªã') ||
                                       currentFilter.includes('L√™ Th·ªã') || currentFilter.includes('Ph·∫°m Th·ªã');
                const title = isTeacherFemale ? 'c√¥' : 'th·∫ßy';
                message = `ƒê√¢y l√† th·ªùi kh√≥a bi·ªÉu c·ªßa ${title} ${currentFilter}`;
            }
            
            // Create or update view notification
            let viewNotification = document.getElementById('viewNotification');
            if (!viewNotification) {
                viewNotification = document.createElement('div');
                viewNotification.id = 'viewNotification';
                viewNotification.className = 'bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg mb-4 text-sm';
                
                const statsPanel = document.getElementById('statisticsPanel');
                statsPanel.parentNode.insertBefore(viewNotification, statsPanel);
            }
            
            viewNotification.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">‚ÑπÔ∏è</span>
                    <span>${message}</span>
                </div>
            `;
        }

        function exportAsWallpaper() {
            if (!currentFilter) {
                showNotification('Vui l√≤ng ch·ªçn l·ªõp ho·∫∑c gi√°o vi√™n tr∆∞·ªõc khi xu·∫•t h√¨nh n·ªÅn!', 'error');
                return;
            }

            createWallpaperPreview();
        }

        function createWallpaperPreview() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'wallpaperModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 1000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 20px;
                max-width: 600px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
            `;

            // Create close button
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '‚úï';
            closeBtn.style.cssText = `
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
                color: #666;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);

            // Create preview title
            const title = document.createElement('h3');
            title.textContent = 'T√πy ch·ªânh h√¨nh n·ªÅn ƒëi·ªán tho·∫°i';
            title.style.cssText = `
                margin: 0 0 20px 0;
                font-size: 18px;
                font-weight: 600;
                color: #333;
                text-align: center;
            `;

            // Create phone selection
            const phoneSelection = document.createElement('div');
            phoneSelection.style.cssText = `
                margin-bottom: 20px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 10px;
            `;
            phoneSelection.innerHTML = `
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">üì± Ch·ªçn d√≤ng ƒëi·ªán tho·∫°i:</label>
                <select id="phoneModel" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <option value="iphone16promax">iPhone 16 Pro Max (1290x2796)</option>
                    <option value="iphone16pro">iPhone 16 Pro (1206x2622)</option>
                    <option value="iphone16plus">iPhone 16 Plus (1290x2796)</option>
                    <option value="iphone16">iPhone 16 (1179x2556)</option>
                    <option value="iphone15promax">iPhone 15 Pro Max (1290x2796)</option>
                    <option value="iphone15pro">iPhone 15 Pro (1179x2556)</option>
                    <option value="iphone14promax">iPhone 14 Pro Max (1290x2796)</option>
                    <option value="iphone14pro">iPhone 14 Pro (1179x2556)</option>
                    <option value="samsungs24ultra">Samsung S24 Ultra (1440x3120)</option>
                    <option value="samsungs24plus">Samsung S24+ (1440x3120)</option>
                    <option value="samsungs24">Samsung S24 (1080x2340)</option>
                    <option value="samsungs23ultra">Samsung S23 Ultra (1440x3088)</option>
                    <option value="xiaomi14ultra">Xiaomi 14 Ultra (1440x3200)</option>
                    <option value="xiaomi14pro">Xiaomi 14 Pro (1440x3200)</option>
                    <option value="oppofindx7ultra">OPPO Find X7 Ultra (1440x3168)</option>
                    <option value="vivox100pro">Vivo X100 Pro (1260x2800)</option>
                    <option value="huaweip60pro">Huawei P60 Pro (1212x2616)</option>
                    <option value="googlepixel8pro">Google Pixel 8 Pro (1344x2992)</option>
                    <option value="oneplus12">OnePlus 12 (1440x3168)</option>
                    <option value="realmegtneo6">Realme GT Neo 6 (1240x2772)</option>
                </select>
            `;

            // Create color selection with 15 colors
            const colorSelection = document.createElement('div');
            colorSelection.style.cssText = `
                margin-bottom: 20px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 10px;
            `;
            colorSelection.innerHTML = `
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">üé® Ch·ªçn m√†u n·ªÅn:</label>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                    <button class="color-btn" data-color="#ffffff" data-text-color="#333333" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: #ffffff; cursor: pointer; position: relative;">
                        <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; color: #333;">Tr·∫Øng</span>
                    </button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #667eea 0%, #764ba2 100%)" data-text-color="#ffffff" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" data-text-color="#ffffff" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)" data-text-color="#ffffff" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)" data-text-color="#ffffff" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #fa709a 0%, #fee140 100%)" data-text-color="#ffffff" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)" data-text-color="#333333" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)" data-text-color="#333333" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)" data-text-color="#ffffff" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)" data-text-color="#333333" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)" data-text-color="#333333" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)" data-text-color="#333333" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #ff8a80 0%, #ea4c89 100%)" data-text-color="#ffffff" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #ff8a80 0%, #ea4c89 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #667db6 0%, #0082c8 100%)" data-text-color="#ffffff" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #667db6 0%, #0082c8 100%); cursor: pointer;"></button>
                    <button class="color-btn" data-color="linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)" data-text-color="#ffffff" style="height: 40px; border-radius: 6px; border: 2px solid #ddd; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); cursor: pointer;"></button>
                </div>
            `;

            // Create iPhone preview container
            const phoneContainer = document.createElement('div');
            phoneContainer.style.cssText = `
                width: 200px;
                height: 400px;
                margin: 0 auto 20px auto;
                background: #000;
                border-radius: 25px;
                padding: 10px;
                position: relative;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;

            // Create wallpaper preview (2/3 of screen)
            const wallpaperPreview = document.createElement('div');
            wallpaperPreview.id = 'wallpaperPreview';
            wallpaperPreview.style.cssText = `
                width: 100%;
                height: 267px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 15px;
                padding: 15px;
                box-sizing: border-box;
                color: white;
                font-family: 'Inter', sans-serif;
                overflow: hidden;
                position: relative;
            `;

            // Generate compact schedule for preview
            generateCompactSchedule(wallpaperPreview);

            // Create bottom area (1/3 of screen)
            const bottomArea = document.createElement('div');
            bottomArea.style.cssText = `
                width: 100%;
                height: 133px;
                background: #1a1a1a;
                border-radius: 0 0 15px 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #666;
                font-size: 10px;
            `;
            bottomArea.textContent = 'Khu v·ª±c ·ª©ng d·ª•ng';

            phoneContainer.appendChild(wallpaperPreview);
            phoneContainer.appendChild(bottomArea);

            // Create download button
            const downloadBtn = document.createElement('button');
            downloadBtn.id = 'downloadBtn';
            downloadBtn.textContent = 'üì± T·∫£i h√¨nh n·ªÅn (1290x2796px)';
            downloadBtn.style.cssText = `
                width: 100%;
                padding: 12px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
            `;
            downloadBtn.onmouseover = () => downloadBtn.style.background = '#5a67d8';
            downloadBtn.onmouseout = () => downloadBtn.style.background = '#667eea';
            downloadBtn.onclick = () => generateFullWallpaper();

            // Add color selection event listeners
            let selectedColor = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            let selectedTextColor = '#ffffff';
            colorSelection.addEventListener('click', (e) => {
                if (e.target.classList.contains('color-btn')) {
                    // Remove previous selection
                    colorSelection.querySelectorAll('.color-btn').forEach(btn => {
                        btn.style.border = '2px solid #ddd';
                    });
                    // Add selection to clicked button
                    e.target.style.border = '3px solid #333';
                    selectedColor = e.target.dataset.color;
                    selectedTextColor = e.target.dataset.textColor;
                    wallpaperPreview.style.background = selectedColor;
                    wallpaperPreview.style.color = selectedTextColor;
                    
                    // Update preview with new colors
                    generateCompactSchedule(wallpaperPreview);
                }
            });

            // Add phone model change event listener
            phoneSelection.addEventListener('change', (e) => {
                if (e.target.id === 'phoneModel') {
                    const phoneSpecs = getPhoneSpecs(e.target.value);
                    downloadBtn.textContent = `üì± T·∫£i h√¨nh n·ªÅn (${phoneSpecs.width}x${phoneSpecs.height}px)`;
                }
            });

            // Assemble modal
            modalContent.appendChild(closeBtn);
            modalContent.appendChild(title);
            modalContent.appendChild(phoneSelection);
            modalContent.appendChild(colorSelection);
            modalContent.appendChild(phoneContainer);
            modalContent.appendChild(downloadBtn);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Set default color selection
            colorSelection.querySelector('.color-btn').style.border = '3px solid #333';
        }

        function getPhoneSpecs(phoneModel) {
            const specs = {
                'iphone16promax': { width: 1290, height: 2796 },
                'iphone16pro': { width: 1206, height: 2622 },
                'iphone16plus': { width: 1290, height: 2796 },
                'iphone16': { width: 1179, height: 2556 },
                'iphone15promax': { width: 1290, height: 2796 },
                'iphone15pro': { width: 1179, height: 2556 },
                'iphone14promax': { width: 1290, height: 2796 },
                'iphone14pro': { width: 1179, height: 2556 },
                'samsungs24ultra': { width: 1440, height: 3120 },
                'samsungs24plus': { width: 1440, height: 3120 },
                'samsungs24': { width: 1080, height: 2340 },
                'samsungs23ultra': { width: 1440, height: 3088 },
                'xiaomi14ultra': { width: 1440, height: 3200 },
                'xiaomi14pro': { width: 1440, height: 3200 },
                'oppofindx7ultra': { width: 1440, height: 3168 },
                'vivox100pro': { width: 1260, height: 2800 },
                'huaweip60pro': { width: 1212, height: 2616 },
                'googlepixel8pro': { width: 1344, height: 2992 },
                'oneplus12': { width: 1440, height: 3168 },
                'realmegtneo6': { width: 1240, height: 2772 }
            };
            return specs[phoneModel] || specs['iphone16promax'];
        }

        function generateCompactSchedule(container) {
            // Clear container
            container.innerHTML = '';
            
            // Filter data for current selection
            const filteredData = scheduleData.filter(record => {
                if (currentViewMode === 'class') {
                    return record.class === currentFilter;
                } else {
                    return record.teacher === currentFilter;
                }
            });

            // Create header
            const header = document.createElement('div');
            header.style.cssText = `
                text-align: center;
                margin-bottom: 10px;
                background: rgba(255,255,255,0.1);
                padding: 8px;
                border-radius: 8px;
                backdrop-filter: blur(10px);
            `;
            
            const studentName = document.getElementById('studentNameInput').value.trim();
            const studentText = studentName ? `<div style="font-size: 10px; margin-bottom: 4px; color: #2563eb; font-weight: bold;">${studentName}</div>` : '';
            
            header.innerHTML = `
                <div style="font-size: 12px; font-weight: bold; margin-bottom: 2px;">THPT Nguy·ªÖn Khuy·∫øn</div>
                <div style="font-size: 9px; margin-bottom: 2px;">${currentViewMode === 'class' ? 'L·ªõp' : 'GV'} ${currentFilter}</div>
                ${studentText}
                <div style="font-size: 8px; opacity: 0.8;">T·ª´ 8/9/2025</div>
            `;

            // Create compact schedule grid
            const schedule = {
                morning: Array(5).fill().map(() => Array(6).fill(null)),
                afternoon: Array(5).fill().map(() => Array(6).fill(null))
            };

            // Fill schedule
            filteredData.forEach(record => {
                const dayInfo = dayMapping[record.day];
                if (dayInfo && record.period >= 1 && record.period <= 5) {
                    const dayIndex = dayInfo.day - 1;
                    const periodIndex = record.period - 1;
                    schedule[dayInfo.session][periodIndex][dayIndex] = record;
                }
            });

            // Determine active days and periods
            const hasDataInPeriod = {
                morning: Array(5).fill(false),
                afternoon: Array(5).fill(false)
            };
            const hasDataInDay = Array(6).fill(false);

            schedule.morning.forEach((periods, periodIndex) => {
                periods.forEach((record, dayIndex) => {
                    if (record) {
                        hasDataInPeriod.morning[periodIndex] = true;
                        hasDataInDay[dayIndex] = true;
                    }
                });
            });

            schedule.afternoon.forEach((periods, periodIndex) => {
                periods.forEach((record, dayIndex) => {
                    if (record) {
                        hasDataInPeriod.afternoon[periodIndex] = true;
                        hasDataInDay[dayIndex] = true;
                    }
                });
            });

            // Create table
            const table = document.createElement('table');
            const textColor = container.style.color || '#ffffff';
            table.style.cssText = `
                width: 100%;
                border-collapse: collapse;
                font-size: 7px;
                background: rgba(255,255,255,0.95);
                border-radius: 6px;
                overflow: hidden;
                color: #333;
            `;

            // Create header row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th style="padding: 3px; background: #f8f9fa; font-weight: bold; font-size: 6px; text-align: center;">Ti·∫øt</th>';
            const dayNames = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            for (let day = 0; day < 6; day++) {
                if (hasDataInDay[day]) {
                    headerRow.innerHTML += `<th style="padding: 3px; background: #f8f9fa; font-weight: bold; font-size: 6px; text-align: center;">${dayNames[day]}</th>`;
                }
            }
            table.appendChild(headerRow);

            // Add morning periods
            for (let period = 0; period < 5; period++) {
                if (!hasDataInPeriod.morning[period]) continue;
                
                const row = document.createElement('tr');
                row.innerHTML = `<td style="padding: 4px 2px; background: rgba(59, 130, 246, 0.15); font-weight: bold; font-size: 6px; color: #1e40af; text-align: center;">S${period + 1}</td>`;
                
                for (let day = 0; day < 6; day++) {
                    if (!hasDataInDay[day]) continue;
                    
                    const record = schedule.morning[period][day];
                    if (record) {
                        row.innerHTML += `<td style="padding: 3px 2px; background: rgba(59, 130, 246, 0.1); font-size: 6px; line-height: 1.2; text-align: center; border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div style="font-weight: bold; color: #1e40af; margin-bottom: 1px;">${record.subject}</div>
                            <div style="font-size: 5px; color: #3b82f6;">P.${record.room}</div>
                        </td>`;
                    } else {
                        row.innerHTML += '<td style="padding: 3px 2px; background: rgba(59, 130, 246, 0.05); font-size: 6px; text-align: center; color: #9ca3af;">-</td>';
                    }
                }
                table.appendChild(row);
            }

            // Add afternoon periods
            for (let period = 0; period < 5; period++) {
                if (!hasDataInPeriod.afternoon[period]) continue;
                
                const row = document.createElement('tr');
                row.innerHTML = `<td style="padding: 4px 2px; background: rgba(245, 158, 11, 0.15); font-weight: bold; font-size: 6px; color: #92400e; text-align: center;">C${period + 1}</td>`;
                
                for (let day = 0; day < 6; day++) {
                    if (!hasDataInDay[day]) continue;
                    
                    const record = schedule.afternoon[period][day];
                    if (record) {
                        row.innerHTML += `<td style="padding: 3px 2px; background: rgba(245, 158, 11, 0.1); font-size: 6px; line-height: 1.2; text-align: center; border: 1px solid rgba(245, 158, 11, 0.3);">
                            <div style="font-weight: bold; color: #92400e; margin-bottom: 1px;">${record.subject}</div>
                            <div style="font-size: 5px; color: #f59e0b;">P.${record.room}</div>
                        </td>`;
                    } else {
                        row.innerHTML += '<td style="padding: 3px 2px; background: rgba(245, 158, 11, 0.05); font-size: 6px; text-align: center; color: #9ca3af;">-</td>';
                    }
                }
                table.appendChild(row);
            }

            container.appendChild(header);
            container.appendChild(table);
        }

        function generateFullWallpaper() {
            // Get selected phone specs and color
            const phoneModel = document.getElementById('phoneModel').value;
            const phoneSpecs = getPhoneSpecs(phoneModel);
            const selectedColor = document.getElementById('wallpaperPreview').style.background;
            const selectedTextColor = document.querySelector('.color-btn[style*="border: 3px solid"]').dataset.textColor;
            
            // Calculate 2/3 dimensions for wallpaper
            const wallpaperWidth = phoneSpecs.width;
            const wallpaperHeight = Math.floor(phoneSpecs.height * 2 / 3);
            
            const wallpaperContainer = document.createElement('div');
            wallpaperContainer.style.cssText = `
                position: fixed;
                top: -9999px;
                left: -9999px;
                width: ${wallpaperWidth}px;
                height: ${wallpaperHeight}px;
                background: ${selectedColor};
                padding: ${Math.floor(wallpaperWidth * 0.05)}px ${Math.floor(wallpaperWidth * 0.03)}px;
                box-sizing: border-box;
                font-family: 'Inter', sans-serif;
                color: ${selectedTextColor};
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            `;

            // Generate the same compact schedule but larger
            generateCompactScheduleForDownload(wallpaperContainer);

            document.body.appendChild(wallpaperContainer);

            // Generate image
            html2canvas(wallpaperContainer, {
                width: wallpaperWidth,
                height: wallpaperHeight,
                scale: 1,
                useCORS: true,
                allowTaint: true,
                backgroundColor: null
            }).then(canvas => {
                // Create download link
                const link = document.createElement('a');
                link.download = `tkb_${currentFilter.replace(/\s+/g, '_')}_${phoneModel}_${wallpaperWidth}x${wallpaperHeight}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // Clean up
                document.body.removeChild(wallpaperContainer);
                document.body.removeChild(document.getElementById('wallpaperModal'));
                showNotification('ƒê√£ t·∫£i h√¨nh n·ªÅn th√†nh c√¥ng!', 'success');
            }).catch(error => {
                console.error('Error generating wallpaper:', error);
                document.body.removeChild(wallpaperContainer);
                showNotification('C√≥ l·ªói khi t·∫°o h√¨nh n·ªÅn!', 'error');
            });
        }

        function generateCompactScheduleForDownload(container) {
            // Filter data for current selection
            const filteredData = scheduleData.filter(record => {
                if (currentViewMode === 'class') {
                    return record.class === currentFilter;
                } else {
                    return record.teacher === currentFilter;
                }
            });

            // Create header
            const header = document.createElement('div');
            header.style.cssText = `
                text-align: center;
                margin-bottom: 30px;
                background: rgba(255,255,255,0.1);
                padding: 25px;
                border-radius: 15px;
                backdrop-filter: blur(10px);
            `;
            
            const studentName = document.getElementById('studentNameInput').value.trim();
            const studentText = studentName ? `<div style="font-size: 28px; margin-bottom: 15px; color: #2563eb; font-weight: bold;">${studentName}</div>` : '';
            
            header.innerHTML = `
                <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">THPT Nguy·ªÖn Khuy·∫øn</div>
                <div style="font-size: 24px; margin-bottom: 10px;">Th·ªùi kh√≥a bi·ªÉu ${currentViewMode === 'class' ? 'l·ªõp' : 'gi√°o vi√™n'} ${currentFilter}</div>
                ${studentText}
                <div style="font-size: 18px; opacity: 0.8;">√Åp d·ª•ng t·ª´ ng√†y 8/9/2025</div>
            `;

            // Create schedule grid (same logic as preview but larger)
            const schedule = {
                morning: Array(5).fill().map(() => Array(6).fill(null)),
                afternoon: Array(5).fill().map(() => Array(6).fill(null))
            };

            filteredData.forEach(record => {
                const dayInfo = dayMapping[record.day];
                if (dayInfo && record.period >= 1 && record.period <= 5) {
                    const dayIndex = dayInfo.day - 1;
                    const periodIndex = record.period - 1;
                    schedule[dayInfo.session][periodIndex][dayIndex] = record;
                }
            });

            const hasDataInPeriod = {
                morning: Array(5).fill(false),
                afternoon: Array(5).fill(false)
            };
            const hasDataInDay = Array(6).fill(false);

            schedule.morning.forEach((periods, periodIndex) => {
                periods.forEach((record, dayIndex) => {
                    if (record) {
                        hasDataInPeriod.morning[periodIndex] = true;
                        hasDataInDay[dayIndex] = true;
                    }
                });
            });

            schedule.afternoon.forEach((periods, periodIndex) => {
                periods.forEach((record, dayIndex) => {
                    if (record) {
                        hasDataInPeriod.afternoon[periodIndex] = true;
                        hasDataInDay[dayIndex] = true;
                    }
                });
            });

            // Create table
            const table = document.createElement('table');
            table.style.cssText = `
                width: 100%;
                border-collapse: collapse;
                font-size: 18px;
                background: rgba(255,255,255,0.95);
                border-radius: 15px;
                overflow: hidden;
                color: #333;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                flex-grow: 1;
            `;

            // Create header row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th style="padding: 15px 8px; background: #f8f9fa; font-weight: bold; font-size: 16px; border: 1px solid #ddd; text-align: center;">Ti·∫øt</th>';
            const dayNames = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            for (let day = 0; day < 6; day++) {
                if (hasDataInDay[day]) {
                    headerRow.innerHTML += `<th style="padding: 15px 8px; background: #f8f9fa; font-weight: bold; font-size: 16px; border: 1px solid #ddd; text-align: center;">${dayNames[day]}</th>`;
                }
            }
            table.appendChild(headerRow);

            // Add morning periods
            for (let period = 0; period < 5; period++) {
                if (!hasDataInPeriod.morning[period]) continue;
                
                const row = document.createElement('tr');
                row.innerHTML = `<td style="padding: 12px 8px; background: rgba(59, 130, 246, 0.15); font-weight: bold; font-size: 14px; border: 1px solid #ddd; text-align: center; color: #1e40af;">S${period + 1}</td>`;
                
                for (let day = 0; day < 6; day++) {
                    if (!hasDataInDay[day]) continue;
                    
                    const record = schedule.morning[period][day];
                    if (record) {
                        row.innerHTML += `<td style="padding: 8px; background: rgba(59, 130, 246, 0.1); font-size: 14px; line-height: 1.3; text-align: center; border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div style="font-weight: bold; margin-bottom: 4px; color: #1e40af;">${record.subject}</div>
                            <div style="font-size: 12px; color: #3b82f6; font-weight: 600;">P.${record.room}</div>
                        </td>`;
                    } else {
                        row.innerHTML += '<td style="padding: 8px; background: rgba(59, 130, 246, 0.05); font-size: 14px; text-align: center; border: 1px solid #ddd; color: #999;">-</td>';
                    }
                }
                table.appendChild(row);
            }

            // Add afternoon periods
            for (let period = 0; period < 5; period++) {
                if (!hasDataInPeriod.afternoon[period]) continue;
                
                const row = document.createElement('tr');
                row.innerHTML = `<td style="padding: 12px 8px; background: rgba(245, 158, 11, 0.15); font-weight: bold; font-size: 14px; border: 1px solid #ddd; text-align: center; color: #92400e;">C${period + 1}</td>`;
                
                for (let day = 0; day < 6; day++) {
                    if (!hasDataInDay[day]) continue;
                    
                    const record = schedule.afternoon[period][day];
                    if (record) {
                        row.innerHTML += `<td style="padding: 8px; background: rgba(245, 158, 11, 0.1); font-size: 14px; line-height: 1.3; text-align: center; border: 1px solid rgba(245, 158, 11, 0.3);">
                            <div style="font-weight: bold; margin-bottom: 4px; color: #92400e;">${record.subject}</div>
                            <div style="font-size: 12px; color: #f59e0b; font-weight: 600;">P.${record.room}</div>
                        </td>`;
                    } else {
                        row.innerHTML += '<td style="padding: 8px; background: rgba(245, 158, 11, 0.05); font-size: 14px; text-align: center; border: 1px solid #ddd; color: #999;">-</td>';
                    }
                }
                table.appendChild(row);
            }

            // Add footer
            const footer = document.createElement('div');
            footer.style.cssText = `
                text-align: center;
                margin-top: 30px;
                font-size: 14px;
                opacity: 0.8;
            `;
            footer.innerHTML = `
                <p style="margin: 0;">üì± H√¨nh n·ªÅn ƒë∆∞·ª£c t·∫°o t·ª´ ·ª©ng d·ª•ng Th·ªùi kh√≥a bi·ªÉu</p>
                <p style="margin: 10px 0 0 0;">üïê T·∫°o l√∫c: ${new Date().toLocaleString('vi-VN')}</p>
            `;

            container.appendChild(header);
            container.appendChild(table);
            container.appendChild(footer);
        }

        // Initialize with sample data
        renderSchedule();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'978e8aa370fe07b1',t:'MTc1NjgzMjE5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
